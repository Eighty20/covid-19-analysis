---
title: "03 - Determing date of initial outbreak for each country"
author: "Murray"
date: "5/9/2020"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(caTools)
library(GGally)
```

# For each country, get: date of first case, date where total_deaths_per_million crosses 0.1

```{r}
sum(is.na(simple_model_data$total_cases))

simple_model_data[is.na(simple_model_data$total_cases),]

simple_model_data <- simple_model_data[!is.na(simple_model_data$total_cases),]

simple_model_data <- simple_model_data[order(simple_model_data$Country),]

simple_model_data$date <- as.Date(simple_model_data$date)

# Start date

start_date_by_country <- 
  as.vector(t((simple_model_data %>%
    filter(total_cases > 0) %>%
    group_by(Country) %>%
    filter(max(total_deaths_per_million) >= 0.1) %>%
    slice(1) %>%
    ungroup() %>%
    select(date))[,1]))

# CD/M > 0.1

significant_deaths_start_date_by_country <- 
  as.vector(t((simple_model_data %>%
    filter(total_deaths_per_million >= 0.1) %>%
    group_by(Country) %>%
    slice(1) %>%
    ungroup() %>%
    select(date))[,1]))

group_sizes <- as.vector(t((simple_model_data %>%
    filter(total_cases > 0) %>%
    group_by(Country) %>%
    filter(max(total_deaths_per_million) >= 0.1) %>%
    summarise(n = n()))[,2]))

simple_model_data <- simple_model_data %>%
    filter(total_cases > 0) %>%
    group_by(Country) %>%
    filter(max(total_deaths_per_million) >= 0.1) %>%
    ungroup() %>%
    mutate(days_since_outbreak = date - as.Date(rep(start_date_by_country, group_sizes)),
           days_since_deaths_crossed_0.1_per_million = date - as.Date(rep(significant_deaths_start_date_by_country, group_sizes)))

```

# Add rolling 5-day averages to data and add a flag for if peak has been reached based on the moving average.

```{r}
deaths_5_day_averages <- c()
infections_5_day_averages <- c()
peak_deaths_already_occurred_indicator <- c()
peak_cases_already_occurred_indicator <- c()

for(i in unique(tests_cases_deaths_data$location)) {
  temp_data <- tests_cases_deaths_data %>% filter(location == i)
  
  temp_deaths_ra <- runmean(temp_data$new_deaths_per_million, k = 5, align = "right")
  temp_cases_ra <- runmean(temp_data$new_cases_per_million, k = 5, align = "right")
  
  deaths_5_day_averages <- c(deaths_5_day_averages, temp_deaths_ra)
  infections_5_day_averages <- c(infections_5_day_averages, temp_cases_ra)
  
  if(length(na.omit(temp_deaths_ra)) == 0) {
    peak_deaths_already_occurred_indicator <- c(peak_deaths_already_occurred_indicator, rep(0, length(temp_deaths_ra)))
  } else {
    peak_deaths_already_occurred_indicator <- c(peak_deaths_already_occurred_indicator,
                                                case_when(which.max(temp_deaths_ra) < length(temp_deaths_ra) - 3 ~ rep(1, length(temp_deaths_ra)),
                                                          TRUE ~ rep(0, length(temp_deaths_ra))))
    
  }
  
  if(length(na.omit(temp_cases_ra)) == 0) {
    peak_cases_already_occurred_indicator <- c(peak_cases_already_occurred_indicator, rep(0, length(temp_cases_ra)))
  } else {
  peak_cases_already_occurred_indicator <- c(peak_cases_already_occurred_indicator,
                                             case_when(which.max(temp_cases_ra) < length(temp_cases_ra) - 3 ~ rep(1, length(temp_cases_ra)),
                                                       TRUE ~ rep(0, length(temp_cases_ra))))
    
  }
}

tests_cases_deaths_data_2 <- tests_cases_deaths_data %>%
  rename(Country = location) %>%
  cbind.data.frame(deaths_5_day_averages, infections_5_day_averages, peak_deaths_already_occurred_indicator, peak_cases_already_occurred_indicator)

simple_model_data <- left_join(simple_model_data,
                               tests_cases_deaths_data_2 %>%
                                 select(Country,
                                        date,
                                        deaths_5_day_averages,
                                        infections_5_day_averages,
                                        peak_deaths_already_occurred_indicator,
                                        peak_cases_already_occurred_indicator) %>%
                                 mutate(date = as.Date(date)))
```

```{r}
# Let's select 10 random countries to compare

random_countries <- sample(unique(simple_model_data$Country), 1)

simple_model_data_2 <- left_join(simple_model_data %>%
                                   filter(population_size >= 3 & peak_deaths_already_occurred_indicator == 1) %>%
                                   group_by(Country) %>%
                                   filter(max(total_deaths) >= 50) %>%
                                   ungroup(),
                                 tests_cases_deaths_data %>%
                                   select (location, date, new_deaths_per_million) %>%
                                   rename(Country = location) %>%
                                   mutate(date = as.Date(date)))

death_curves <- list()
death_curves_by_threshold <- list()

canada_data <- simple_model_data_2 %>% filter(Country == "Canada")

ggplot(data = canada_data,
       aes(x = days_since_outbreak, y = runmean(new_deaths_per_million, 5))) +
  geom_line()

for(i in unique(simple_model_data_2$Country)) {
  death_curves[[i]] <- ggplot(data = simple_model_data_2 %>% filter(Country == i),
                              aes(x = days_since_outbreak, y = new_deaths_per_million, color = Country)) +
    geom_line() +
    geom_point() +
    geom_line(data = simple_model_data_2 %>% filter(Country == i),
              aes(x = days_since_outbreak, y = runmean(new_deaths_per_million, 5, align = "right"), color = "5-day rolling average"))
  
    death_curves_by_threshold[[i]] <- ggplot(data = simple_model_data_2 %>% filter(Country == i),
                              aes(x = days_since_deaths_crossed_0.1_per_million, y = new_deaths_per_million, color = Country)) +
    geom_line() +
    geom_point() +
    geom_line(data = simple_model_data_2 %>% filter(Country == i),
              aes(x = days_since_deaths_crossed_0.1_per_million, y = runmean(new_deaths_per_million, 5, align = "right"), color = "5-day rolling average"))
}

# Comparing these two graphs, it seems days_since_deaths_crossed_0.1_per_million brings peaks closer together, so is probably preferable
simple_model_data_2 %>%
  group_by(Country) %>%
  filter(deaths_5_day_averages == max(deaths_5_day_averages)) %>%
  ggplot(aes(x = days_since_outbreak)) +
    geom_density()

simple_model_data_2 %>%
  group_by(Country) %>%
  filter(deaths_5_day_averages == max(deaths_5_day_averages)) %>%
  ggplot(aes(x = days_since_deaths_crossed_0.1_per_million)) +
    geom_density()
```

```{r}
death_curves[1:20]
```

```{r}
death_curves[21:40]
```

```{r}
death_curves_by_threshold[1:20]
```

```{r}
death_curves_by_threshold[21:40]
```

