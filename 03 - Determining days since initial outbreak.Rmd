---
title: "03 - Determing date of initial outbreak for each country"
author: "Murray"
date: "5/9/2020"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(caTools)
library(GGally)
```

# Let's set day one to be day of first case  in each country

```{r}
sum(is.na(simple_model_data$total_cases))

simple_model_data[is.na(simple_model_data$total_cases),]

simple_model_data <- simple_model_data[!is.na(simple_model_data$total_cases),]

simple_model_data <- simple_model_data[order(simple_model_data$Country),]

simple_model_data$date <- as.Date(simple_model_data$date)

start_date_by_country <- 
  as.vector(t((simple_model_data %>%
    filter(total_cases > 0) %>%
    group_by(Country) %>%
    slice(1) %>%
    ungroup() %>%
    select(date))[,1]))

group_sizes <- as.vector(t((simple_model_data %>%
    filter(total_cases > 0) %>%
    group_by(Country) %>%
    summarise(n = n()))[,2]))

simple_model_data <- simple_model_data %>%
    filter(total_cases > 0) %>%
    mutate(days_since_outbreak = date - as.Date(rep(start_date_by_country, group_sizes)))

start_date_by_country <- 
  as.vector(t((simple_model_data %>%
    filter(total_cases > 0) %>%
    group_by(Country) %>%
    slice(1) %>%
    ungroup() %>%
    select(date))[,1]))

group_sizes <- as.vector(t((simple_model_data %>%
    filter(total_cases > 0) %>%
    group_by(Country) %>%
    summarise(n = n()))[,2]))

simple_model_data <- simple_model_data %>%
    filter(total_cases > 0) %>%
    mutate(days_since_outbreak = date - as.Date(rep(start_date_by_country, group_sizes)))

```

```{r}
# Let's select 10 random countries to compare

random_countries <- sample(unique(simple_model_data$Country), 1)

simple_model_data_2 <- left_join(simple_model_data, tests_cases_deaths_data %>% select (location, date, new_deaths_per_million) %>% rename(Country = location) %>% mutate(date = as.Date(date)))

death_curves <- list()

canada_data <- simple_model_data_2 %>% filter(Country == "Canada")

canada_smooth <- cbind.data.frame(loess.smooth(x = canada_data$days_since_outbreak, y = canada_data$new_deaths_per_million, span = 2/3)$x,
                                  loess.smooth(x = canada_data$days_since_outbreak, y = canada_data$new_deaths_per_million, span = 0.1)$y)

names(canada_smooth) <- c("x", "y")

ggplot(data = canada_smooth,
       aes(x = x, y = y)) +
  geom_line()

ggplot(data = canada_data,
       aes(x = days_since_outbreak, y = runmean(new_deaths_per_million, 5))) +
  geom_line()

simple_model_data

for(i in unique(simple_model_data$Country)) {
  death_curves[[i]] <- ggplot(data = simple_model_data_2 %>% filter(Country == i),
                              aes(x = days_since_outbreak, y = new_deaths_per_million, color = Country)) +
    geom_line() +
    geom_point() +
    geom_line(data = simple_model_data_2 %>% filter(Country == i),
              aes(x = days_since_outbreak, y = runmean(new_deaths_per_million, 5, align = "right"), color = "5-day rolling average"))
}

death_curves[1:20]
```

```{r}
death_curves[21:40]
```

```{r}
death_curves[41:60]
```

```{r}
death_curves[21:80]
```

```{r}
death_curves[21:100]
```

```{r}
death_curves[21:120]
```

```{r}
death_curves[121:140]
```

```{r}
death_curves[141:160]
```

```{r}
death_curves[161:180]
```

```{r}
death_curves[181:200]
```

```{r}
death_curves[201:220]
```

# Add rolling 5-day averages to data

```{r}
deaths_5_day_averages <- c()
infections_5_day_averages <- c()
peak_deaths_already_occurred_indicator <- c()
peak_cases_already_occurred_indicator <- c()

for(i in unique(tests_cases_deaths_data$location)) {
  temp_data <- tests_cases_deaths_data %>% filter(location == i)
  
  temp_deaths_ra <- runmean(temp_data$new_deaths_per_million, k = 5, align = "right")
  temp_cases_ra <- runmean(temp_data$new_cases_per_million, k = 5, align = "right")
  
  deaths_5_day_averages <- c(deaths_5_day_averages, temp_deaths_ra)
  infections_5_day_averages <- c(infections_5_day_averages, temp_cases_ra)
  
  if(length(na.omit(temp_deaths_ra)) == 0) {
    peak_deaths_already_occurred_indicator <- c(peak_deaths_already_occurred_indicator, rep(0, length(temp_deaths_ra)))
  } else {
    peak_deaths_already_occurred_indicator <- c(peak_deaths_already_occurred_indicator,
                                                case_when(which.max(temp_deaths_ra) < length(temp_deaths_ra) - 3 ~ rep(1, length(temp_deaths_ra)),
                                                          TRUE ~ rep(0, length(temp_deaths_ra))))
    
  }
  
  if(length(na.omit(temp_cases_ra)) == 0) {
    peak_cases_already_occurred_indicator <- c(peak_cases_already_occurred_indicator, rep(0, length(temp_cases_ra)))
  } else {
  peak_cases_already_occurred_indicator <- c(peak_cases_already_occurred_indicator,
                                             case_when(which.max(temp_cases_ra) < length(temp_cases_ra) - 3 ~ rep(1, length(temp_cases_ra)),
                                                       TRUE ~ rep(0, length(temp_cases_ra))))
    
  }
}

tests_cases_deaths_data_2 <- tests_cases_deaths_data %>%
  rename(Country = location) %>%
  cbind.data.frame(deaths_5_day_averages, infections_5_day_averages, peak_deaths_already_occurred_indicator, peak_cases_already_occurred_indicator)

simple_model_data <- left_join(simple_model_data, tests_cases_deaths_data_2 %>% select(Country,
                                                                                        date,
                                                                                        deaths_5_day_averages,
                                                                                        infections_5_day_averages,
                                                                                        peak_deaths_already_occurred_indicator,
                                                                                        peak_cases_already_occurred_indicator))
```

