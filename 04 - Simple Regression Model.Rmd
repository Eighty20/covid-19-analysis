---
title: "03 - Simple Regression Model"
author: "Murray"
date: "5/9/2020"
output: html_document
---

GLM Predicts deaths x days after initial outbreak given average age, GDP (PPP), and Obesity rate. m2 is the best and then one I've been using.

Other options:

  Total Number of deaths t days after 1st infection.
  Total Number of deaths t days after infections crossed 0.1 per million people.
  
Could use t as a choice before fitting the model, or as an independent variable. In latter case watch out for non-linearity of relationship.

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ciTools)

simple_model_data %>% filter(Country == "SouthAfrica" & date == "2020-05-11")
```

```{r}
model_variables <- simple_model_data %>%
  group_by(Country, Obesity_rate, gdp_estimate_ppp, Median_Age, population_size, peak_deaths_already_occurred_indicator,
           risk_adjusted_age, Density_km, Inequality_spatial_transformed, gov_response_at_0.1_deaths_per_million) %>%
  mutate(total_deaths = max(total_deaths, na.rm = T)) %>%
  filter(deaths_5_day_averages == max(deaths_5_day_averages, na.rm = T)) %>% # Just keeps the day(s) of the peak for each country
  summarise(total_deaths_per_million = max(total_deaths_per_million, na.rm = T),
            smooth_new_deaths_per_million = max(deaths_5_day_averages, na.rm = T),
            total_deaths = max(total_deaths, na.rm = T)) %>%
  filter(!is.na(Obesity_rate) &
         #!is.na(gdp_estimate_ppp) &
         !is.na(total_deaths_per_million) &
         !is.na(risk_adjusted_age) &
         !(is.na(Density_km)) &
         !is.na(gov_response_at_0.1_deaths_per_million) &
         peak_deaths_already_occurred_indicator == 1 &
         population_size >= 3 &
         total_deaths >= 50 &
         Country != c("China")
         ) %>%
  mutate(combined_density_measure = Density_km * Inequality_spatial_transformed)

# Check distributions of independent variables
ggplot(data = model_variables, aes(x = Obesity_rate)) +
  geom_density()

ggplot(data = model_variables, aes(x = risk_adjusted_age)) +
  geom_density()

ggplot(data = model_variables, aes(x = gdp_estimate_ppp)) +
  geom_density()

ggplot(data = model_variables, aes(x = Inequality_spatial_transformed)) +
  geom_density()

ggplot(data = model_variables, aes(x = log(Inequality_spatial_transformed))) +
  geom_density()
# 
# ggplot(data = model_variables, aes(x = log(risk_adjusted_age))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = log(gdp_estimate_ppp))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = sqrt(risk_adjusted_age))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = sqrt(gdp_estimate_ppp))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = risk_adjusted_age^(1/3))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = gdp_estimate_ppp^(1/3))) +
#   geom_density()
```

```{r}
ggplot(data = model_variables, aes(x = gdp_estimate_ppp, y = deaths_per_million)) +
  geom_line()

ggplot(data = model_variables, aes(x = Median_Age, y = deaths_per_million)) +
  geom_line()

ggplot(data = model_variables, aes(x = Obesity_rate, y = deaths_per_million)) +
  geom_line()
```

```{r}
m1 <- glm(data = model_variables, formula = deaths_per_million ~ risk_adjusted_age)

a1 <- anova(m1)

summary(m1)
```

```{r}
m1 <- glm(data = model_variables, family = Gamma("log"), formula = deaths_per_million ~ risk_adjusted_age)

m2 <- glm(data = model_variables, family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp)

m3 <- glm(data = model_variables, family = Gamma("log"),
          formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + Inequality_spatial_transformed)

m3b <- glm(data = model_variables, family = Gamma("log"),
          formula = deaths_per_million ~ Obesity_rate + Inequality_spatial_transformed)

m3c <- glm(data = model_variables, family = Gamma("log"),
          formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + combined_density_measure)

m4 <- glm(data = model_variables, family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gov_response_at_0.1_deaths_per_million)

m5 <- glm(data = model_variables, family = Gamma("log"),
          formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gov_response_at_0.1_deaths_per_million + Inequality_spatial_transformed)

m5b <- glm(data = model_variables, family = Gamma("log"),
          formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp + gov_response_at_0.1_deaths_per_million + Inequality_spatial_transformed)

summary(m1)
summary(m2)
summary(m3)
summary(m3b)
summary(m3c)
summary(m4)
summary(m5)
summary(m5b)
```

```{r}
32.727/57.006
20.619/57.006

simple_model_data %>% filter(!(Country %in% model_variables$Country) & date == "2020-05-11") %>%
  select(Country, total_deaths_per_million) %>%
  cbind.data.frame(predictions)

predict.glm(m3b, newdata = simple_model_data %>% filter((Country == "SouthAfrica") & date == "2020-05-11"), se.fit = T, type = "response")

predictions_vs_actual <- add_pi(tb = simple_model_data %>%
                                  filter(!(Country %in% model_variables$Country) & date == "2020-05-11") %>%
                                  mutate(deaths_per_million = 0), fit = m5) %>%
  select(Country, total_deaths_per_million, pred, LPB0.025, UPB0.975)

# 
# ggplot(data = predictions_vs_actual[order(predictions_vs_actual$pred),], aes(x = pred, y = total_deaths_per_million)) +
#     geom_line() + 
#     geom_ribbon(aes(ymin = LPB0.025, ymax = UPB0.975), alpha = 0.2) +
#     lims(y = c(0, 300))

cbind.data.frame(model_variables %>% ungroup %>% select(Country, deaths_per_million), m5$fitted.values)
m5$R

cor(model_variables %>% ungroup() %>% select(Obesity_rate, risk_adjusted_age, gdp_estimate_ppp, gov_response_at_0.1_deaths_per_million, Density_km, Inequality_spatial_transformed)) %>% View()
```

```{r}
m4 <- glm(data = model_variables %>% filter(deaths_per_million > 0), family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp + risk_adjusted_age * Obesity_rate)

summary(m4)
```

```{r}
m5 <- glm(data = model_variables %>% filter(deaths_per_million > 0), family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp + risk_adjusted_age * gdp_estimate_ppp)

summary(m5)
```

```{r}
m6 <- glm(data = model_variables %>% filter(deaths_per_million > 0), family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp + gdp_estimate_ppp * Obesity_rate)

summary(m6)
```

```{r}
m7 <- glm(data = model_variables %>% filter(deaths_per_million > 0), family = Gamma("log"), formula = deaths_per_million ~ Median_Age * log(gdp_estimate_ppp))

summary(m7)
```


```{r}
ggplot(data = model_variables, aes(x = m1$fitted.values, y = deaths_per_million)) + 
  geom_point() +
  geom_text(aes(label = Country), size = 3, check_overlap = T, nudge_y = 7) +
  geom_line(aes(y = seq(0, 300, length.out = dim(model_variables)[1]), x = seq(0, 300, length.out = dim(model_variables)[1])), linetype = "dashed") +
  labs(title = "deaths_per_million ~ Obesity_rate + risk_adjusted_age",
       subtitle = "For countries that have observed a peak in deaths and have population > 3 million",
       x = "Fitted Values",
       y = "Actual Values")
ggplot(data = model_variables, aes(x = m5$fitted.values, y = deaths_per_million)) + 
  geom_point() +
  geom_text(aes(label = Country), size = 3, check_overlap = T, nudge_y = 7) +
  geom_line(aes(y = seq(0, 300, length.out = dim(model_variables)[1]), x = seq(0, 300, length.out = dim(model_variables)[1])), linetype = "dashed") +
  labs(title = "DPM ~ Obesity_rate + risk_adjusted_age + gov_response + spatial_inequality",
       subtitle = "For countries that have observed a peak in deaths and have population > 3 million",
       x = "Fitted Values",
       y = "Actual Values")
```



```{r}
plot(m2)
```



