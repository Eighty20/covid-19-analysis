---
title: "03 - Simple Regression Model"
author: "Murray"
date: "5/9/2020"
output: html_document
---

GLM Predicts deaths x days after initial outbreak given average age, GDP (PPP), and Obesity rate. m2 is the best and then one I've been using.

Other options:

  Total Number of deaths t days after 1st infection.
  Total Number of deaths t days after infections crossed 0.1 per million people.
  
Could use t as a choice before fitting the model, or as an independent variable. In latter case watch out for non-linearity of relationship.

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ciTools)

simple_model_data %>% filter(Country == "SouthAfrica" & date == "2020-05-11")
```

```{r}
model_variables <- simple_model_data %>%
  group_by(Country, Obesity_rate, gdp_estimate_ppp, Median_Age, population_size, peak_deaths_already_occurred_indicator, risk_adjusted_age) %>%
  filter(deaths_5_day_averages == max(deaths_5_day_averages)) %>%
  summarise(deaths_per_million = max(total_deaths_per_million),
            smooth_deaths_per_million = max(deaths_5_day_averages),
            total_deaths = max(total_deaths)) %>%
  filter(!is.na(Obesity_rate) & !is.na(gdp_estimate_ppp) & !is.na(Median_Age) & !is.na(deaths_per_million) & !is.na(risk_adjusted_age) &
           peak_deaths_already_occurred_indicator == 1 &
           population_size > 3 &
           total_deaths > 50 &
           Country != c("China")
         )

# Check distributions of independent variables
# ggplot(data = model_variables, aes(x = Obesity_rate)) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = risk_adjusted_age)) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = gdp_estimate_ppp)) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = log(risk_adjusted_age))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = log(gdp_estimate_ppp))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = sqrt(risk_adjusted_age))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = sqrt(gdp_estimate_ppp))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = risk_adjusted_age^(1/3))) +
#   geom_density()
# 
# ggplot(data = model_variables, aes(x = gdp_estimate_ppp^(1/3))) +
#   geom_density()
```

```{r}
ggplot(data = model_variables, aes(x = gdp_estimate_ppp, y = deaths_per_million)) +
  geom_line()

ggplot(data = model_variables, aes(x = Median_Age, y = deaths_per_million)) +
  geom_line()

ggplot(data = model_variables, aes(x = Obesity_rate, y = deaths_per_million)) +
  geom_line()
```

```{r}
m1 <- glm(data = model_variables, formula = deaths_per_million ~ risk_adjusted_age)

a1 <- anova(m1)

summary(m1)
```

```{r}
m2 <- glm(data = model_variables, family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp)

summary(m2)
```

```{r}
simple_model_data %>% filter(!(Country %in% model_variables$Country) & date == "2020-05-11") %>%
  select(Country, total_deaths_per_million) %>%
  cbind.data.frame(predictions)

predict.glm(m2, newdata = simple_model_data %>% filter((Country == "SouthAfrica") & date == "2020-05-11"), se.fit = T, type = "response")

predictions_vs_actual <- add_pi(tb = simple_model_data %>%
                                  filter(!(Country %in% model_variables$Country) & date == "2020-05-11") %>%
                                  mutate(deaths_per_million = 0), fit = m2) %>%
  select(Country, total_deaths_per_million, pred, LPB0.025, UPB0.975)

# 
# ggplot(data = predictions_vs_actual[order(predictions_vs_actual$pred),], aes(x = pred, y = total_deaths_per_million)) +
#     geom_line() + 
#     geom_ribbon(aes(ymin = LPB0.025, ymax = UPB0.975), alpha = 0.2) +
#     lims(y = c(0, 300))

```

```{r}
m4 <- glm(data = model_variables %>% filter(deaths_per_million > 0), family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp + risk_adjusted_age * Obesity_rate)

summary(m4)
```

```{r}
m5 <- glm(data = model_variables %>% filter(deaths_per_million > 0), family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp + risk_adjusted_age * gdp_estimate_ppp)

summary(m5)
```

```{r}
m6 <- glm(data = model_variables %>% filter(deaths_per_million > 0), family = Gamma("log"), formula = deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_estimate_ppp + gdp_estimate_ppp * Obesity_rate)

summary(m6)
```

```{r}
m7 <- glm(data = model_variables %>% filter(deaths_per_million > 0), family = Gamma("log"), formula = deaths_per_million ~ Median_Age * log(gdp_estimate_ppp))

summary(m7)
```


```{r}
ggplot(data = model_variables, aes(x = m2$fitted.values, y = deaths_per_million)) + 
  geom_point() +
  geom_text(aes(label = Country), size = 3, check_overlap = T, nudge_y = 7) +
  geom_line(aes(y = seq(0, 300, length.out = 31), x = seq(0, 300, length.out = 31)), linetype = "dashed") +
  labs(title = "deaths_per_million ~ Obesity_rate + risk_adjusted_age + gdp_per_capita_ppp",
       subtitle = "For countries that have observed a peak in deaths and have population > 3 million",
       x = "Fitted Values",
       y = "Actual Values")
```

```{r}
ggplot(data = model_variables %>% filter(deaths_per_million > 0), aes(x = m2$fitted.values, y = deaths_per_million)) + 
  geom_point()
```


```{r}
plot(m2)
```



